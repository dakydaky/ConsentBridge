@page
@model MockAgent.ConsoleApp.Pages.IndexModel
@{
    ViewData["Title"] = "Agent Dashboard";
}

<h2>Agent Dashboard</h2>
<script>
  async function refreshDashboard() {
    try {
      const res = await fetch('?handler=Data');
      if (!res.ok) return;
      const data = await res.json();
      // Update Pending Requests
      const tbodyP = document.querySelector('#pending tbody');
      tbodyP.innerHTML = data.pending.map(r => `<tr><td>${r.candidateEmail}</td><td><code>${r.id}</code></td><td>${new Date(r.createdAt).toLocaleString()}</td><td><a class="btn btn-sm btn-outline-secondary" href="${data.publicBaseUrl}${r.link}" target="_blank">Open</a></td></tr>`).join('');
      // Update Active Consents
      const tbodyC = document.querySelector('#consents tbody');
      tbodyC.innerHTML = data.consents.map(c => `<tr><td>${c.approvedByEmail || '(hidden)'}</td><td>${c.status}</td><td><code>ctok:${c.tokenId}</code></td><td>${new Date(c.tokenExpiresAt).toLocaleString()}</td><td><form method="post" action="?handler=Revoke&id=${c.id}" class="d-inline"><button class="btn btn-sm btn-outline-danger">Revoke</button></form> <form method="post" action="?handler=Renew&id=${c.id}" class="d-inline"><button class="btn btn-sm btn-outline-primary">Renew</button></form></td></tr>`).join('');
    } catch {}
  }
  document.addEventListener('DOMContentLoaded', () => {
    refreshDashboard();
    try {
      const es = new EventSource('/events');
      es.onmessage = () => refreshDashboard();
      es.onerror = () => { /* ignore */ };
    } catch {}
    setInterval(refreshDashboard, 15000); // fallback periodic refresh
  });
  </script>

<div class="mb-3">
    <a class="btn btn-primary" asp-page="/Consents/New">Request Consent</a>
    <a class="btn btn-success" asp-page="/Applications/New">Submit Application</a>
    <a class="btn btn-outline-secondary" href="/">Refresh</a>
  </div>

<div class="row">
    <div class="col-md-6">
        <h4>Future Candidates (not consented yet)</h4>
        <table class="table table-sm">
            <thead><tr><th>Email</th><th>Job</th><th>When</th></tr></thead>
            <tbody>
            @foreach (var c in Model.Candidates)
            {
                <tr>
                    <td>@c.CandidateEmail</td>
                    <td>@c.JobRef</td>
                    <td>@c.CreatedAt.LocalDateTime</td>
                </tr>
            }
            </tbody>
        </table>
        <h4>Pending Requests</h4>
        <table class="table table-sm" id="pending">
            <thead><tr><th>Candidate</th><th>Request ID</th><th>When</th><th>Open</th></tr></thead>
            <tbody>
            @foreach (var c in Model.PendingRequests)
            {
                <tr>
                    <td>@c.CandidateEmail</td>
                    <td><code>@c.Id</code></td>
                    <td>@c.CreatedAt.ToLocalTime()</td>
                    <td><a class="btn btn-sm btn-outline-secondary" href="@Model.PublicBaseUrl@c.link" target="_blank">Open</a></td>
                </tr>
            }
            </tbody>
        </table>
        <h4 class="mt-4">Active Consents</h4>
        <table class="table table-sm" id="consents">
            <thead><tr><th>Email</th><th>Status</th><th>Token</th><th>Expires</th><th>Actions</th></tr></thead>
            <tbody>
            @foreach (var c in Model.Consents)
            {
                <tr>
                    <td>@(string.IsNullOrEmpty(c.ApprovedByEmail) ? "(hidden)" : c.ApprovedByEmail)</td>
                    <td>@c.Status</td>
                    <td><code>ctok:@c.TokenId</code></td>
                    <td>@c.TokenExpiresAt.ToLocalTime()</td>
                    <td>
                        <form method="post" asp-page-handler="Revoke" asp-route-id="@c.Id" class="d-inline">
                            <button class="btn btn-sm btn-outline-danger">Revoke</button>
                        </form>
                        <form method="post" asp-page-handler="Renew" asp-route-id="@c.Id" class="d-inline">
                            <button class="btn btn-sm btn-outline-primary">Renew</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <h4>Recent Applications</h4>
        <table class="table table-sm">
            <thead><tr><th>Candidate</th><th>Job</th><th>Result</th><th>When</th></tr></thead>
            <tbody>
            @foreach (var a in Model.Applications)
            {
                <tr>
                    <td>@a.CandidateEmail</td>
                    <td>@a.JobRef</td>
                    <td><code>@a.ResponseSnippet</code></td>
                    <td>@a.CreatedAt.LocalDateTime</td>
                </tr>
            }
            </tbody>
        </table>
    </div>
  </div>

